name: Java CI with Maven

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-tags: true
        fetch-depth: 1
    
    - name: Git setup
      run: |
        git config --global user.email olauncher@example.com
        git config --global user.name olauncher

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    - name: Set up OLauncher and Fix 0012
      run: |
        bash decompile.sh
        bash init.sh
        
        # 1. 移除报错的 0012 补丁
        # 我们后面会手动实现它的功能，避免 git am 报错
        rm launcher-patches/0012-Add-version-information.patch
        
        # 2. 运行剩余补丁
        sed -i 's/git am/git am --ignore-whitespace/g' applyPatches.sh
        bash applyPatches.sh || true # 允许失败，防止因为缺少0012导致后续补丁微小错位
        
        # 3. 手动创建 LauncherVersion.java (这是 0012 的核心功能，缺了它会编译失败)
        # 我们创建一个目录并写入一个简化版的类，足以支持运行
        mkdir -p src/main/java/dev/figboot/olauncher/launcher/
        cat > src/main/java/dev/figboot/olauncher/launcher/LauncherVersion.java <<EOF
        package dev.figboot.olauncher.launcher;
        public final class LauncherVersion {
            public static String getLauncherName() { return "OLauncher"; }
            public static String getVersion() { return "Custom-Build"; }
        }
        EOF
        
        # 4. 修复 LauncherConstants.java 的引用 (模拟 0012 的修改)
        # 添加 import
        sed -i '/import java.net.URL;/a import dev.figboot.olauncher.launcher.LauncherVersion;' src/main/java/net/minecraft/launcher/LauncherConstants.java
        # 替换 getVersionName 方法的内容
        sed -i 's/LauncherConstants.class.getPackage().getImplementationVersion()/LauncherVersion.getVersion()/g' src/main/java/net/minecraft/launcher/LauncherConstants.java

        # 5. 自定义窗口标题 (解决你的最终需求)
        # 我们使用通配符匹配 setTitle(...)，直接替换为你的自定义标题
        # 这样无论反编译出来的变量名是 var12 还是 var10 都能成功修改
        
        # 修改 Main.java (加载小窗口)
        sed -i 's/.*setTitle(.*);/var12.setTitle("Minecraft Launcher");/g' src/main/java/net/minecraft/launcher/Main.java || echo "Main.java patch failed"
        # 如果 var12 不对，尝试用更宽泛的匹配
        sed -i 's/.*\.setTitle(.*);/        var12.setTitle("Minecraft Launcher");/' src/main/java/net/minecraft/launcher/Main.java

        # 修改 SwingUserInterface.java (主窗口)
        # 注意：这里需要先把中文转为 Unicode 避免乱码，"我的启动器" = \u6211\u7684\u542f\u52a8\u5668
        sed -i 's/.*setTitle(.*);/        this.frame.setTitle("\\u6211\\u7684\\u542f\\u52a8\\u5668");/g' src/main/java/net/minecraft/launcher/SwingUserInterface.java

    - name: Build with Maven
      run: mvn --batch-mode --update-snapshots verify

    - name: Generate redistributable
      run: bash genredist.sh

    - name: Upload redistributable
      uses: actions/upload-artifact@v4
      id: upload-artifact
      with:
        name: OLauncher Redistributable JAR
        path: olauncher-*-redist.jar

  draft-release:
    if: ${{ github.ref_type == 'tag' }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download redistributable jar
        uses: actions/download-artifact@v4
        id: download-artifact
        with:
          artifact-ids: ${{ needs.build.outputs.artifact-id }}
          merge-multiple: true
          path: redist
      - name: Create release draft with redistributable
        env:
          RELEASE_TAG: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          ARTIFACT_PATH: ${{ steps.download-artifact.outputs.download-path }}
        run: gh release create "$RELEASE_TAG" --draft --verify-tag --title "$RELEASE_TAG" "$ARTIFACT_PATH"/*.jar
